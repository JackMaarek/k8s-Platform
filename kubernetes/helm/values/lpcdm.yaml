# lpcdm — LOCAL-DEV fixture
# Static nginx app used to validate the full infra stack locally:
#   - Istio mTLS + VirtualService + DestinationRule
#   - ServiceMonitor → Prometheus scrape
#   - multi-env routing (dev / staging / prod)
#   - ArgoCD sync + selfHeal
#
# This file is NOT part of the template. It is a local-test fixture.
# The equivalent for a real app is generated by platform-bot app add.

nameOverride: "lpcdm"
fullnameOverride: "lpcdm"

image:
  repository: ghcr.io/podyourlife/lpcdm
  pullPolicy: Always
  tag: "latest"

imagePullSecrets:
  - name: ghcr-pull-secret

replicaCount: 1

service:
  type: ClusterIP
  port: 80
  targetPort: 8080

livenessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 15
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 128Mi

autoscaling:
  enabled: false

podLabels:
  version: v1

secret:
  enabled: true
  name: lpcdm-supabase-secret

# Copy files into emptyDir to allow sed commands on entrypoint script
initContainers:
  - name: copy-assets
    image: ghcr.io/podyourlife/lpcdm:latest
    command:
      - sh
      - -c
      - cp -r /usr/share/nginx/html/assets/. /assets/
    volumeMounts:
      - name: nginx-assets
        mountPath: /assets
    securityContext:
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 1000

# Allow ngnix write on path
volumes:
  - name: nginx-cache
    emptyDir: {}
  - name: nginx-run
    emptyDir: {}
  - name: nginx-assets
    emptyDir: {}

volumeMounts:
  - name: nginx-cache
    mountPath: /var/cache/nginx
  - name: nginx-run
    mountPath: /var/run
  - name: nginx-assets
    mountPath: /usr/share/nginx/html/assets